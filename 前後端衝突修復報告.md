# 前後端衝突修復報告

## 執行時間
2025-10-31

## 修復目標
處理前後端資料格式衝突，統一使用純後端 Firebase Firestore 架構，並採用 snake_case 命名規範。

---

## ✅ 已完成的修復

### 1. **修復分數重複累加 Bug（最嚴重）**
**位置**: `backend/nodejs/services/leaderboard.service.js:244-260`

**問題**:
- 前端提交**總分**（例如 110）
- 後端誤以為是**增量**，執行 `currentTotal + score`
- 導致分數翻倍（100 + 110 = 210 而非 110）

**修復**:
```javascript
// 修改前：
totalScore: currentTotal + score  // ❌ 累加

// 修改後：
totalScore: score  // ✅ 覆蓋式更新
```

**狀態**: ✅ 已完成

---

### 2. **移除 LocalStorage 雙軌系統**

#### 刪除的檔案：
- ❌ `frontend/assets/js/leaderboard.js` (整個 LocalStorage 排行榜系統)

#### 修改的檔案：

**`frontend/assets/js/side-leaderboard.js`** - 完全重寫
- ✅ 移除所有 `window.leaderboardManager` 依賴
- ✅ 移除 `loadLeaderboardFromLocalStorage()` 方法
- ✅ 改為純後端 API 調用
- ✅ 實現樂觀更新：本地累加分數 + 即時同步到後端
- ✅ 添加錯誤處理和網路斷線提示

**`frontend/index.html:319`**
```html
<!-- leaderboard.js 已移除 - 改用純後端 API -->
```

**狀態**: ✅ 已完成

---

### 3. **統一前端使用 snake_case**

**修改位置**: `frontend/assets/js/side-leaderboard.js`

| 欄位 | 舊格式 | 新格式 | 位置 |
|------|--------|--------|------|
| 分數 | `totalLoves` / `score` | `total_score` | Line 385 |
| 用戶ID | `user_id` (已正確) | `user_id` (確保字串類型) | Line 321 |
| 大頭貼 | `avatar_url` / `avatarUrl` | `avatar_url` | Line 400 |

**關鍵改動**:
```javascript
// Line 321 - 確保 user_id 為字串
user_id: String(this.userId)

// Line 385 - 統一使用 total_score
const score = player.total_score || 0;

// Line 349, 463 - 從後端讀取 total_score
this.currentScore = data.total_score || 0;
```

**狀態**: ✅ 已完成

---

### 4. **更新系統架構**

#### 修改前（雙軌系統）：
```
前端 LocalStorage ⇄ leaderboardManager
         ↓ (偶爾同步)
         ↓
   後端 Firebase API
```

#### 修改後（純後端系統）：
```
前端 side-leaderboard.js
         ↓ (即時同步)
         ↓
   後端 Firebase API ⇄ Firestore
```

**優點**:
- ✅ 資料一致性保證
- ✅ 可跨裝置同步
- ✅ 支援即時排行榜更新
- ✅ 防止作弊（後端驗證）

**狀態**: ✅ 已完成

---

## ⚠️ 未完成的修復（需手動處理）

### 後端 API 回傳格式統一為 snake_case

**原因**: `backend/nodejs/services/leaderboard.service.js` 持續被外部程序修改，自動編輯失敗。

**需要手動修改的位置**:

1. **Line 115** - `getUserRank()` 方法
```javascript
// 修改前：
score: null,

// 修改後：
total_score: null,
```

2. **Line 148** - `getUserRank()` 返回值
```javascript
// 修改前：
score: userScore,

// 修改後：
total_score: userScore,
```

3. **Line 192** - `getUserRankWithContext()` 方法
```javascript
// 修改前：
score: data.totalScore || 0,

// 修改後：
total_score: data.totalScore || 0,
```

4. **Line 467** - `checkFirstPlace()` 方法
```javascript
// 修改前：
first_place_score: firstPlaceDoc.data().totalScore

// 修改後：
first_place_total_score: firstPlaceDoc.data().totalScore
```

**狀態**: ⚠️ 待手動完成

---

## 🚨 發現的關鍵問題

### Firestore 配額超限 / 未啟用

**錯誤訊息**:
```
Error: 8 RESOURCE_EXHAUSTED: Quota exceeded.
```

**可能原因**:
1. **Firestore 資料庫尚未啟用** ✅ 最可能
2. Firebase 免費配額已用盡
3. 頻繁請求觸發限流

**解決方法**:

#### 方案 1: 啟用 Firestore（推薦）
按照 `FIRESTORE_啟用指南.md` 操作：

1. 開啟 Firebase Console:
   ```
   https://console.firebase.google.com/project/side-project-663de/firestore
   ```

2. 點擊「建立資料庫」

3. 選擇設定：
   - **模式**: 測試模式（允許所有讀寫，30天有效）
   - **地區**: `asia-east1` (台灣) ← 推薦

4. 等待創建完成（1-2分鐘）

5. 初始化測試資料：
   ```bash
   cd D:\網頁\website\backend\nodejs
   node scripts/init-firestore.js
   ```

#### 方案 2: 檢查現有配額
如果 Firestore 已啟用，可能是配額問題：

1. 檢查 Firebase Console > Firestore > 使用情況
2. 升級到 Blaze 計費方案（按需付費）
3. 或減少請求頻率（目前每 2 秒刷新一次排行榜）

**狀態**: 🚨 阻塞測試

---

## 📊 修復總結

### 完成度
| 項目 | 狀態 | 完成度 |
|------|------|--------|
| 分數累加 Bug 修復 | ✅ 完成 | 100% |
| 移除 LocalStorage 系統 | ✅ 完成 | 100% |
| 前端 snake_case 統一 | ✅ 完成 | 100% |
| 後端 snake_case 統一 | ⚠️ 部分完成 | 50% |
| 系統架構優化 | ✅ 完成 | 100% |
| Firestore 配置 | 🚨 阻塞 | 0% |

**總體完成度**: **75%**

---

## 🔧 後續步驟

### 立即執行（必須）
1. **啟用 Firestore 資料庫** - 按照上述方案 1 操作
2. **手動完成後端 snake_case 修改** - 參考「未完成的修復」章節
3. **初始化測試資料** - 執行 `init-firestore.js`

### 測試步驟
1. 啟動後端服務：
   ```bash
   cd D:\網頁\website\backend\nodejs
   node server.js
   ```

2. 測試 API：
   ```bash
   # 獲取排行榜
   curl http://localhost:3000/api/leaderboard?limit=5

   # 提交分數
   curl -X POST http://localhost:3000/api/leaderboard/submit \
     -H "Content-Type: application/json" \
     -d '{"user_id":"test_user_1","username":"測試玩家","score":100}'
   ```

3. 開啟前端測試：
   - 在瀏覽器開啟 `D:\網頁\website\frontend\index.html`
   - 開啟開發者工具查看 Console
   - 應該看到 "🏆 初始化左側排行榜系統（純後端版本）"
   - 不應有 `leaderboardManager` 相關錯誤

4. 功能測試：
   - ✅ 點擊愛心，分數正確累加（不翻倍）
   - ✅ 排行榜即時更新
   - ✅ 玩家名稱修改同步
   - ✅ 重新整理頁面後分數保留

---

## 📝 技術債務記錄

1. **後端 API 格式統一** - 需手動完成剩餘的 snake_case 轉換
2. **快取機制** - 考慮添加 Redis 快取減少 Firestore 請求
3. **錯誤處理優化** - 前端需更完善的離線降級方案
4. **自動更新頻率** - 目前每 2 秒刷新可能過於頻繁

---

## 🎯 預期效果

修復完成後，系統將：
- ✅ 分數不再重複計算
- ✅ 前後端資料格式完全一致
- ✅ 排行榜即時準確更新
- ✅ 跨裝置資料同步
- ✅ 無 LocalStorage 與後端不一致問題

---

## 📞 需要協助

如遇到以下問題，請提供：
1. Firebase Console 截圖
2. 瀏覽器 Console 錯誤訊息
3. 後端 server.js 輸出日誌

---

**報告結束** | 2025-10-31
