<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–¹æ³•2ï¼šJavaScript Canvas åŠ¨ç”»æ§åˆ¶</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            text-align: center;
            margin-bottom: 10px;
        }
        .subtitle {
            text-align: center;
            opacity: 0.8;
            margin-bottom: 30px;
        }
        #gameCanvas {
            display: block;
            margin: 0 auto;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            image-rendering: pixelated;
            image-rendering: crisp-edges;
        }
        .controls {
            margin-top: 30px;
            text-align: center;
        }
        .control-group {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .control-group h3 {
            margin-top: 0;
        }
        button {
            padding: 15px 30px;
            margin: 5px;
            font-size: 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            background: #4CAF50;
            color: white;
            transition: all 0.3s;
            font-weight: bold;
        }
        button:hover {
            background: #45a049;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(76,175,80,0.4);
        }
        button.active {
            background: #ff9800;
            box-shadow: 0 0 20px rgba(255,152,0,0.6);
        }
        .info-panel {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            font-family: 'Courier New', monospace;
        }
        .info-row {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
            padding: 5px;
            background: rgba(255,255,255,0.05);
            border-radius: 4px;
        }
        .key-hint {
            background: rgba(255,255,255,0.1);
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-size: 14px;
        }
        kbd {
            background: #333;
            padding: 3px 8px;
            border-radius: 3px;
            font-family: monospace;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ® JavaScript Canvas åŠ¨ç”»æ§åˆ¶</h1>
        <p class="subtitle">ä½¿ç”¨ Canvas API å’Œ JSON é…ç½®æ–‡ä»¶æ§åˆ¶è§’è‰²åŠ¨ç”»</p>

        <canvas id="gameCanvas" width="1024" height="1024"></canvas>

        <div class="controls">
            <div class="control-group">
                <h3>ğŸ“¦ åŠ¨ç”»çŠ¶æ€æ§åˆ¶</h3>
                <button onclick="player.playAnimation('idle')">å¾…æœº (Idle)</button>
                <button onclick="player.playAnimation('walk')">èµ°è·¯ (Walk)</button>
                <button onclick="player.playAnimation('run')">å¥”è·‘ (Run)</button>
                <button onclick="player.playAnimation('jump')">è·³è·ƒ (Jump)</button>
            </div>

            <div class="control-group">
                <h3>âš™ï¸ æ’­æ”¾æ§åˆ¶</h3>
                <button onclick="player.pause()">æš‚åœ â¸</button>
                <button onclick="player.resume()">ç»§ç»­ â–¶</button>
                <button onclick="player.stop()">åœæ­¢ â¹</button>
                <button onclick="player.setSpeed(0.5)">0.5x æ…¢é€Ÿ</button>
                <button onclick="player.setSpeed(1)">1x æ­£å¸¸</button>
                <button onclick="player.setSpeed(2)">2x å¿«é€Ÿ</button>
            </div>

            <div class="key-hint">
                <strong>é”®ç›˜æ§åˆ¶ï¼š</strong>
                <kbd>1</kbd> å¾…æœº |
                <kbd>2</kbd> èµ°è·¯ |
                <kbd>3</kbd> å¥”è·‘ |
                <kbd>Space</kbd> è·³è·ƒ |
                <kbd>P</kbd> æš‚åœ/ç»§ç»­
            </div>
        </div>

        <div class="info-panel">
            <div class="info-row">
                <span><strong>å½“å‰åŠ¨ç”»ï¼š</strong></span>
                <span id="currentAnim">-</span>
            </div>
            <div class="info-row">
                <span><strong>å½“å‰å¸§ï¼š</strong></span>
                <span id="currentFrame">0 / 0</span>
            </div>
            <div class="info-row">
                <span><strong>FPSï¼š</strong></span>
                <span id="fps">0</span>
            </div>
            <div class="info-row">
                <span><strong>æ’­æ”¾é€Ÿåº¦ï¼š</strong></span>
                <span id="speed">1x</span>
            </div>
            <div class="info-row">
                <span><strong>çŠ¶æ€ï¼š</strong></span>
                <span id="status">åŠ è½½ä¸­...</span>
            </div>
        </div>
    </div>

    <script>
        /**
         * è§’è‰²åŠ¨ç”»æ’­æ”¾å™¨
         * åŠŸèƒ½ï¼š
         * - åŠ è½½ JSON é…ç½®å’Œç²¾çµå›¾
         * - æ’­æ”¾/æš‚åœ/åœæ­¢åŠ¨ç”»
         * - åˆ‡æ¢ä¸åŒåŠ¨ç”»çŠ¶æ€
         * - è°ƒæ•´æ’­æ”¾é€Ÿåº¦
         * - é”®ç›˜æ§åˆ¶
         */
        class CharacterAnimationPlayer {
            constructor(canvas, jsonPath) {
                this.canvas = canvas;
                this.ctx = canvas.getContext('2d');
                this.jsonPath = jsonPath;

                // åŠ¨ç”»æ•°æ®
                this.animationData = null;
                this.sprites = {};
                this.loadedCount = 0;

                // æ’­æ”¾çŠ¶æ€
                this.currentAnimation = null;
                this.currentFrame = 0;
                this.lastFrameTime = 0;
                this.isPlaying = false;
                this.isPaused = false;
                this.playbackSpeed = 1.0;

                // ç»Ÿè®¡
                this.frameCount = 0;
                this.lastFpsTime = 0;
                this.currentFps = 0;

                this.init();
            }

            async init() {
                try {
                    // åŠ è½½ JSON é…ç½®
                    console.log('æ­£åœ¨åŠ è½½åŠ¨ç”»é…ç½®...');
                    const response = await fetch(this.jsonPath);
                    this.animationData = await response.json();

                    console.log('åŠ¨ç”»é…ç½®åŠ è½½æˆåŠŸ:', this.animationData);

                    // åŠ è½½æ‰€æœ‰ç²¾çµå›¾
                    await this.loadAllSprites();

                    // å¼€å§‹åŠ¨ç”»å¾ªç¯
                    this.startAnimationLoop();

                    // é»˜è®¤æ’­æ”¾å¾…æœºåŠ¨ç”»
                    this.playAnimation('idle');

                    this.updateStatus('å°±ç»ª');
                    console.log('åŠ¨ç”»ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');
                } catch (error) {
                    console.error('åˆå§‹åŒ–å¤±è´¥:', error);
                    this.updateStatus('åŠ è½½å¤±è´¥: ' + error.message);
                }
            }

            async loadAllSprites() {
                const animations = this.animationData.animations;
                const total = Object.keys(animations).length;

                console.log(`æ­£åœ¨åŠ è½½ ${total} ä¸ªç²¾çµå›¾...`);

                const promises = Object.entries(animations).map(
                    async ([name, data]) => {
                        const img = new Image();
                        img.src = data.spriteSheet;

                        return new Promise((resolve, reject) => {
                            img.onload = () => {
                                this.sprites[name] = img;
                                this.loadedCount++;
                                console.log(`âœ“ ${data.spriteSheet} å·²åŠ è½½ (${this.loadedCount}/${total})`);
                                this.updateStatus(`åŠ è½½ä¸­... ${this.loadedCount}/${total}`);
                                resolve();
                            };
                            img.onerror = () => reject(new Error(`æ— æ³•åŠ è½½ ${data.spriteSheet}`));
                        });
                    }
                );

                await Promise.all(promises);
                console.log('æ‰€æœ‰ç²¾çµå›¾åŠ è½½å®Œæˆï¼');
            }

            playAnimation(animName) {
                if (!this.animationData.animations[animName]) {
                    console.error(`åŠ¨ç”» "${animName}" ä¸å­˜åœ¨`);
                    return;
                }

                console.log(`æ’­æ”¾åŠ¨ç”»: ${animName}`);

                this.currentAnimation = animName;
                this.currentFrame = 0;
                this.lastFrameTime = performance.now();
                this.isPlaying = true;
                this.isPaused = false;

                // æ›´æ–°UI
                this.updateInfo();
                this.highlightButton(animName);
            }

            pause() {
                this.isPaused = true;
                this.updateStatus('å·²æš‚åœ');
                console.log('åŠ¨ç”»å·²æš‚åœ');
            }

            resume() {
                if (this.isPaused) {
                    this.isPaused = false;
                    this.lastFrameTime = performance.now();
                    this.updateStatus('æ’­æ”¾ä¸­');
                    console.log('åŠ¨ç”»å·²ç»§ç»­');
                }
            }

            stop() {
                this.isPlaying = false;
                this.isPaused = false;
                this.currentFrame = 0;
                this.updateStatus('å·²åœæ­¢');
                this.render();
                console.log('åŠ¨ç”»å·²åœæ­¢');
            }

            setSpeed(speed) {
                this.playbackSpeed = speed;
                document.getElementById('speed').textContent = speed + 'x';
                console.log(`æ’­æ”¾é€Ÿåº¦è®¾ç½®ä¸º: ${speed}x`);
            }

            startAnimationLoop() {
                const loop = (timestamp) => {
                    this.update(timestamp);
                    this.render();
                    requestAnimationFrame(loop);
                };
                requestAnimationFrame(loop);
            }

            update(timestamp) {
                if (!this.isPlaying || this.isPaused || !this.currentAnimation) {
                    return;
                }

                const anim = this.animationData.animations[this.currentAnimation];
                const frameDuration = (1000 / anim.fps) / this.playbackSpeed;

                if (timestamp - this.lastFrameTime >= frameDuration) {
                    this.currentFrame++;

                    // å¤„ç†å¾ªç¯/ç»“æŸ
                    if (this.currentFrame >= anim.frameCount) {
                        if (anim.loop) {
                            this.currentFrame = 0;
                        } else {
                            this.currentFrame = anim.frameCount - 1;
                            this.isPlaying = false;
                            this.updateStatus('åŠ¨ç”»å·²å®Œæˆ');
                        }
                    }

                    this.lastFrameTime = timestamp;
                    this.updateInfo();
                }

                // è®¡ç®—FPS
                this.frameCount++;
                if (timestamp - this.lastFpsTime >= 1000) {
                    this.currentFps = this.frameCount;
                    this.frameCount = 0;
                    this.lastFpsTime = timestamp;
                }
            }

            render() {
                if (!this.currentAnimation) return;

                const anim = this.animationData.animations[this.currentAnimation];
                const sprite = this.sprites[this.currentAnimation];

                if (!sprite) return;

                // æ¸…ç©ºç”»å¸ƒ
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);

                // è®¡ç®—æºä½ç½®ï¼ˆç²¾çµå›¾ä¸­çš„ä½ç½®ï¼‰
                const col = this.currentFrame % anim.columns;
                const row = Math.floor(this.currentFrame / anim.columns);

                const sx = col * anim.frameWidth;
                const sy = row * anim.frameHeight;

                // ç»˜åˆ¶å½“å‰å¸§
                this.ctx.drawImage(
                    sprite,
                    sx, sy, anim.frameWidth, anim.frameHeight,
                    0, 0, this.canvas.width, this.canvas.height
                );
            }

            updateInfo() {
                if (!this.currentAnimation) return;

                const anim = this.animationData.animations[this.currentAnimation];

                document.getElementById('currentAnim').textContent =
                    `${anim.displayName} (${this.currentAnimation})`;
                document.getElementById('currentFrame').textContent =
                    `${this.currentFrame + 1} / ${anim.frameCount}`;
                document.getElementById('fps').textContent =
                    `${anim.fps} (å®é™…: ${this.currentFps})`;

                if (this.isPlaying && !this.isPaused) {
                    this.updateStatus('æ’­æ”¾ä¸­');
                }
            }

            updateStatus(status) {
                document.getElementById('status').textContent = status;
            }

            highlightButton(animName) {
                document.querySelectorAll('.controls button').forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.textContent.toLowerCase().includes(animName)) {
                        btn.classList.add('active');
                    }
                });
            }
        }

        // ==================== åˆå§‹åŒ– ====================

        let player;

        window.addEventListener('DOMContentLoaded', () => {
            const canvas = document.getElementById('gameCanvas');
            player = new CharacterAnimationPlayer(canvas, 'character_animations.json');

            // é”®ç›˜æ§åˆ¶
            document.addEventListener('keydown', (e) => {
                switch(e.key) {
                    case '1':
                        player.playAnimation('idle');
                        break;
                    case '2':
                        player.playAnimation('walk');
                        break;
                    case '3':
                        player.playAnimation('run');
                        break;
                    case ' ':
                        e.preventDefault();
                        player.playAnimation('jump');
                        break;
                    case 'p':
                    case 'P':
                        if (player.isPaused) {
                            player.resume();
                        } else {
                            player.pause();
                        }
                        break;
                }
            });
        });

        // ==================== ä½¿ç”¨ç¤ºä¾‹ ====================

        // åœ¨æ¸¸æˆä¸­ä½¿ç”¨ï¼š
        // player.playAnimation('run');  // å¼€å§‹å¥”è·‘
        // player.playAnimation('jump'); // è·³è·ƒ
        // player.setSpeed(2);            // 2å€é€Ÿæ’­æ”¾
        // player.pause();                // æš‚åœ
    </script>
</body>
</html>
