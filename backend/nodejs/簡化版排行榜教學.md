# 簡化版排行榜系統 - 完整教學

## 🎯 簡介

這是一個**簡化版**的排行榜系統，使用 **Node.js + MySQL** 架構。
相比原本的複雜版本（PHP + Node.js + MySQL + Redis），這個版本：

- ✅ **只用一種後端語言**（Node.js/JavaScript）
- ✅ **不需要 Redis**（減少一個軟體）
- ✅ **更容易理解和學習**
- ✅ **適合中小規模使用**（幾千到幾萬筆記錄）

---

## 📁 系統架構

```
前端 (網頁)
    ↓ 呼叫 API
Node.js Express 伺服器
    ↓ 查詢資料庫
MySQL 資料庫
```

### 檔案結構

```
D:\網頁\website/
├── START_LEADERBOARD.bat          # 一鍵啟動腳本
├── backend/
│   ├── nodejs/                    # Node.js 後端
│   │   ├── server.js              # 主伺服器
│   │   ├── config/
│   │   │   └── database.js        # 資料庫配置
│   │   ├── services/
│   │   │   └── leaderboard.service.js  # 排行榜邏輯
│   │   ├── routes/
│   │   │   └── leaderboard.routes.js   # API 路由
│   │   ├── package.json           # 依賴管理
│   │   └── .env                   # 環境變數
│   └── database/
│       └── schema-simplified.sql  # 簡化版資料庫結構
└── frontend/                      # 前端檔案
```

---

## 🚀 快速開始

### 方法 1：一鍵啟動（推薦）

雙擊 `START_LEADERBOARD.bat` 即可！

### 方法 2：手動啟動

1. **啟動 MySQL 服務**
2. **開啟命令提示字元**
3. **執行以下指令：**

```bash
cd D:\網頁\website\backend\nodejs
npm start
```

4. **等待出現以下訊息：**

```
🚀 Simplified Leaderboard API Server
📡 Listening on port 3000
✅ MySQL connected

📋 Available endpoints:
   GET  http://localhost:3000/api/leaderboard
   GET  http://localhost:3000/api/leaderboard/my-rank/:userId
   GET  http://localhost:3000/api/leaderboard/around/:userId
   POST http://localhost:3000/api/leaderboard/submit
```

5. **伺服器成功啟動！**

---

## 📡 API 使用說明

### 1. 獲取排行榜

**請求：**
```http
GET http://localhost:3000/api/leaderboard?page=1&limit=10
```

**回應範例：**
```json
{
  "success": true,
  "page": 1,
  "limit": 10,
  "total": 3,
  "total_pages": 1,
  "data": [
    {
      "rank": 1,
      "user_id": 1,
      "username": "Alice",
      "score": 400
    },
    {
      "rank": 2,
      "user_id": 2,
      "username": "Bob",
      "score": 295
    }
  ]
}
```

### 2. 獲取個人排名

**請求：**
```http
GET http://localhost:3000/api/leaderboard/my-rank/1
```

**回應範例：**
```json
{
  "success": true,
  "user_id": 1,
  "username": "Alice",
  "rank": 1,
  "score": 400,
  "total_users": 3,
  "percentile": "100.00%"
}
```

### 3. 提交分數

**請求：**
```http
POST http://localhost:3000/api/leaderboard/submit
Content-Type: application/json

{
  "user_id": 1,
  "score": 50
}
```

**回應範例：**
```json
{
  "success": true,
  "score_id": 8,
  "user_id": 1,
  "score": 50,
  "message": "Score submitted successfully"
}
```

---

## 🗄️ 資料庫結構

### 1. users 表（用戶表）

| 欄位 | 類型 | 說明 |
|------|------|------|
| id | INT | 用戶ID（主鍵） |
| username | VARCHAR(50) | 用戶名稱 |
| created_at | TIMESTAMP | 建立時間 |
| updated_at | TIMESTAMP | 更新時間 |

### 2. love_scores 表（分數記錄表）

| 欄位 | 類型 | 說明 |
|------|------|------|
| id | BIGINT | 記錄ID（主鍵） |
| user_id | INT | 用戶ID（外鍵） |
| love_count | INT | 愛心數量 |
| action_type | VARCHAR(50) | 遊戲類型 |
| created_at | TIMESTAMP | 建立時間 |

### 3. user_total_loves 表（總分數快取表）

| 欄位 | 類型 | 說明 |
|------|------|------|
| user_id | INT | 用戶ID（主鍵） |
| total_loves | INT | 總愛心數 |
| last_updated | TIMESTAMP | 最後更新時間 |

**為什麼需要快取表？**
- 查詢排行榜時，直接從這個表讀取總分，速度更快
- 不需要每次都 `SUM()` 計算，效能提升 10 倍以上

---

## 🔧 後端運作原理

### 1. 伺服器啟動流程

```
1. 載入環境變數 (.env)
   ↓
2. 連接 MySQL 資料庫
   ↓
3. 設定 API 路由
   ↓
4. 啟動 Express 伺服器（監聽 3000 端口）
```

### 2. API 請求處理流程

**以「獲取排行榜」為例：**

```
前端發送請求
   ↓
routes/leaderboard.routes.js（接收請求，驗證參數）
   ↓
services/leaderboard.service.js（查詢資料庫）
   ↓
MySQL 查詢：
   SELECT u.id, u.username, t.total_loves
   FROM user_total_loves t
   INNER JOIN users u ON t.user_id = u.id
   ORDER BY t.total_loves DESC
   LIMIT 10
   ↓
組裝回應 JSON
   ↓
回傳給前端
```

### 3. 提交分數的邏輯

當用戶提交分數時：

1. **檢查用戶是否存在**
2. **插入記錄到 `love_scores` 表**（保存每次的分數）
3. **更新 `user_total_loves` 表**（累加總分）

使用 SQL：
```sql
INSERT INTO user_total_loves (user_id, total_loves, last_updated)
VALUES (1, 50, NOW())
ON DUPLICATE KEY UPDATE
  total_loves = total_loves + VALUES(total_loves),
  last_updated = NOW()
```

這個語法的意思：
- 如果用戶不存在 → 新增記錄
- 如果用戶已存在 → 累加分數

---

## 💡 常見問題

### Q1: 如何新增測試用戶？

**方法 1：用 MySQL 指令**
```sql
INSERT INTO users (id, username) VALUES (4, '你的名字');
```

**方法 2：用 phpMyAdmin 或其他 GUI 工具**

### Q2: 如何清空排行榜？

```sql
TRUNCATE TABLE love_scores;
TRUNCATE TABLE user_total_loves;
```

### Q3: 伺服器啟動失敗怎麼辦？

**檢查清單：**
1. MySQL 服務是否啟動？
2. `.env` 檔案的資料庫密碼是否正確？
3. 3000 端口是否被佔用？

**查看 3000 端口佔用：**
```bash
netstat -ano | findstr :3000
```

**殺掉佔用進程：**
```bash
taskkill /F /PID <進程ID>
```

### Q4: 如何修改伺服器端口？

編輯 `.env` 檔案：
```
PORT=3001  # 改成你想要的端口
```

### Q5: 如何重設資料庫？

```bash
mysql -u root
```

```sql
DROP DATABASE leaderboard_db;
SOURCE D:/網頁/website/backend/database/schema-simplified.sql;
```

---

## 📚 學習重點

### 1. 什麼是後端？

後端就像餐廳的廚房：
- **前端**（網頁）= 餐廳外場（客人看得到的地方）
- **後端**（Node.js）= 廚房（處理訂單、準備餐點）
- **資料庫**（MySQL）= 倉庫（儲存食材）

### 2. 什麼是 API？

API 就像餐廳的菜單：
- 菜單上有「牛肉麵」、「炒飯」
- API 有 `/api/leaderboard`、`/api/leaderboard/submit`

前端透過 API「點餐」，後端「準備餐點」並回傳。

### 3. 為什麼需要資料庫？

如果沒有資料庫：
- 關閉伺服器 → 所有分數都消失！

有了資料庫：
- 分數永久保存在硬碟中
- 隨時可以查詢、排序、統計

### 4. 什麼是快取表？

**沒有快取表：**
```sql
-- 每次查排行榜都要計算總分（慢）
SELECT user_id, SUM(love_count) as total
FROM love_scores
GROUP BY user_id
ORDER BY total DESC
```

**有快取表：**
```sql
-- 直接讀取已算好的總分（快）
SELECT user_id, total_loves
FROM user_total_loves
ORDER BY total_loves DESC
```

---

## 🔍 進階學習

### 1. 如何新增功能？

**範例：新增「每週排行榜」**

**步驟：**
1. 在 `services/leaderboard.service.js` 新增方法
2. 在 `routes/leaderboard.routes.js` 新增路由
3. 測試 API

### 2. 如何優化效能？

**目前的瓶頸：**
- 查詢排行榜時，每次都從 MySQL 讀取

**優化方案：**
- 加入 Redis 快取（進階）
- 定時重建排行榜（每小時更新一次）

### 3. 如何部署到網路上？

**選項 1：租用雲端主機**
- AWS、Google Cloud、Azure
- 需要設定防火牆、開放 3000 端口

**選項 2：使用 Heroku、Railway 等平台**
- 更簡單，但有限制

---

## 🎓 總結

恭喜你完成簡化版排行榜系統！

**你已經學會：**
✅ Node.js 後端伺服器
✅ Express 框架
✅ MySQL 資料庫
✅ REST API 設計
✅ 前後端分離架構

**下一步學習方向：**
1. 學習 Redis 快取
2. 學習用戶註冊/登入
3. 學習部署到雲端
4. 學習 Docker 容器化

加油！🚀
