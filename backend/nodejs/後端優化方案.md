# å¾Œç«¯å„ªåŒ–æ–¹æ¡ˆ ğŸš€

**ç•¶å‰ç‹€æ…‹**: è‰¯å¥½ï¼Œä½†å¯ä»¥æ›´å¥½
**å„ªåŒ–ç›®æ¨™**: ä¼æ¥­ç´šã€é«˜æ€§èƒ½ã€æ˜“ç¶­è­·

---

## ğŸ“Š ç¾æœ‰æ¶æ§‹åˆ†æ

### âœ… å·²æœ‰çš„å„ªå‹¢

| é …ç›® | ç‹€æ…‹ | è©•åˆ† |
|------|------|------|
| Express æ¡†æ¶ | âœ… | â­â­â­â­ |
| Firestore æ•¸æ“šåº« | âœ… | â­â­â­â­â­ |
| Redis ç·©å­˜ | âœ… | â­â­â­â­â­ |
| API è·¯ç”±åˆ†é›¢ | âœ… | â­â­â­â­ |
| ç›£æ§ç³»çµ± | âœ… | â­â­â­â­ |
| æ¸¬è©¦è…³æœ¬ | âœ… | â­â­â­ |

### âš ï¸ å¯æ”¹é€²çš„åœ°æ–¹

| å•é¡Œ | å½±éŸ¿ | å„ªå…ˆç´š |
|------|------|--------|
| ç¼ºå°‘çµ±ä¸€éŒ¯èª¤è™•ç† | ä¸­ | ğŸ”´ é«˜ |
| ç¼ºå°‘è«‹æ±‚é©—è­‰å±¤ | é«˜ | ğŸ”´ é«˜ |
| ç¼ºå°‘é€Ÿç‡é™åˆ¶ | é«˜ | ğŸ”´ é«˜ |
| æ—¥èªŒç³»çµ±ç°¡é™‹ | ä¸­ | ğŸŸ¡ ä¸­ |
| ç¼ºå°‘ API æ–‡æª” | ä½ | ğŸŸ¢ ä½ |
| æ•¸æ“šåº«æŸ¥è©¢æœªå„ªåŒ– | ä¸­ | ğŸŸ¡ ä¸­ |

---

## ğŸ¯ å„ªåŒ–è¨ˆåŠƒ

### éšæ®µä¸€ï¼šå®‰å…¨èˆ‡ç©©å®šæ€§ï¼ˆé«˜å„ªå…ˆç´šï¼‰

#### 1. çµ±ä¸€éŒ¯èª¤è™•ç†ä¸­é–“ä»¶ â­â­â­â­â­

**å•é¡Œ**: å„è·¯ç”±éŒ¯èª¤è™•ç†ä¸ä¸€è‡´ï¼Œé›£ä»¥ç¶­è­·

**è§£æ±ºæ–¹æ¡ˆ**:
```javascript
// middleware/errorHandler.js
class AppError extends Error {
  constructor(message, statusCode, code = 'INTERNAL_ERROR') {
    super(message);
    this.statusCode = statusCode;
    this.code = code;
    this.isOperational = true;
  }
}

const errorHandler = (err, req, res, next) => {
  err.statusCode = err.statusCode || 500;
  err.code = err.code || 'INTERNAL_ERROR';

  // é–‹ç™¼ç’°å¢ƒï¼šè©³ç´°éŒ¯èª¤
  if (process.env.NODE_ENV === 'development') {
    res.status(err.statusCode).json({
      success: false,
      error: {
        code: err.code,
        message: err.message,
        stack: err.stack,
        details: err.details
      }
    });
  }
  // ç”Ÿç”¢ç’°å¢ƒï¼šç°¡åŒ–éŒ¯èª¤
  else {
    res.status(err.statusCode).json({
      success: false,
      error: {
        code: err.code,
        message: err.isOperational ? err.message : 'ä¼ºæœå™¨éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦'
      }
    });
  }

  // è¨˜éŒ„éŒ¯èª¤
  if (!err.isOperational) {
    console.error('ğŸ’¥ éé æœŸéŒ¯èª¤:', err);
  }
};
```

#### 2. è«‹æ±‚é©—è­‰å±¤ (Joi/Zod) â­â­â­â­â­

**å•é¡Œ**: ç¼ºå°‘è¼¸å…¥é©—è­‰ï¼Œå®¹æ˜“å—åˆ°æƒ¡æ„è«‹æ±‚æ”»æ“Š

**è§£æ±ºæ–¹æ¡ˆ**:
```javascript
// middleware/validate.js
const Joi = require('joi');

const schemas = {
  submitScore: Joi.object({
    player_id: Joi.string().required().max(100),
    username: Joi.string().required().min(2).max(20),
    score: Joi.number().integer().min(0).max(1000000).required()
  }),

  createWish: Joi.object({
    player_id: Joi.string().required().max(100),
    username: Joi.string().required().min(2).max(20),
    content: Joi.string().required().min(5).max(200)
  }),

  submitFeedback: Joi.object({
    player_id: Joi.string().required().max(100),
    username: Joi.string().required().min(2).max(20),
    category: Joi.string().valid('bug', 'feature', 'combat', 'other').required(),
    message: Joi.string().required().min(10).max(500)
  })
};

const validate = (schemaName) => {
  return (req, res, next) => {
    const { error } = schemas[schemaName].validate(req.body);

    if (error) {
      return res.status(400).json({
        success: false,
        error: {
          code: 'VALIDATION_ERROR',
          message: error.details[0].message
        }
      });
    }

    next();
  };
};
```

#### 3. é€Ÿç‡é™åˆ¶ (Rate Limiting) â­â­â­â­â­

**å•é¡Œ**: æ²’æœ‰é€Ÿç‡é™åˆ¶ï¼Œå®¹æ˜“è¢«æ¿«ç”¨

**è§£æ±ºæ–¹æ¡ˆ**:
```javascript
// middleware/rateLimiter.js
const rateLimit = require('express-rate-limit');

// API é€šç”¨é™åˆ¶ï¼šæ¯åˆ†é˜ 60 æ¬¡
const apiLimiter = rateLimit({
  windowMs: 60 * 1000,
  max: 60,
  message: {
    success: false,
    error: {
      code: 'RATE_LIMIT_EXCEEDED',
      message: 'è«‹æ±‚éæ–¼é »ç¹ï¼Œè«‹ç¨å¾Œå†è©¦'
    }
  }
});

// æäº¤é™åˆ¶ï¼šæ¯åˆ†é˜ 5 æ¬¡
const submitLimiter = rateLimit({
  windowMs: 60 * 1000,
  max: 5,
  message: {
    success: false,
    error: {
      code: 'SUBMIT_LIMIT_EXCEEDED',
      message: 'æäº¤éæ–¼é »ç¹ï¼Œè«‹ç¨å¾Œå†è©¦'
    }
  }
});

// è¨±é¡˜é™åˆ¶ï¼šæ¯åˆ†é˜ 3 æ¬¡
const wishLimiter = rateLimit({
  windowMs: 60 * 1000,
  max: 3,
  message: {
    success: false,
    error: {
      code: 'WISH_LIMIT_EXCEEDED',
      message: 'è¨±é¡˜éæ–¼é »ç¹ï¼Œè«‹ç­‰å¾…ä¸€åˆ†é˜'
    }
  }
});
```

#### 4. é€²éšæ—¥èªŒç³»çµ± (Winston) â­â­â­â­

**å•é¡Œ**: åªæœ‰ç°¡å–®çš„ console.logï¼Œé›£ä»¥è¿½è¹¤å•é¡Œ

**è§£æ±ºæ–¹æ¡ˆ**:
```javascript
// utils/logger.js
const winston = require('winston');
const path = require('path');

const logger = winston.createLogger({
  level: process.env.LOG_LEVEL || 'info',
  format: winston.format.combine(
    winston.format.timestamp(),
    winston.format.errors({ stack: true }),
    winston.format.json()
  ),
  transports: [
    // éŒ¯èª¤æ—¥èªŒ
    new winston.transports.File({
      filename: path.join(__dirname, '../logs/error.log'),
      level: 'error'
    }),
    // æ‰€æœ‰æ—¥èªŒ
    new winston.transports.File({
      filename: path.join(__dirname, '../logs/combined.log')
    })
  ]
});

// é–‹ç™¼ç’°å¢ƒï¼šè¼¸å‡ºåˆ°æ§åˆ¶å°
if (process.env.NODE_ENV !== 'production') {
  logger.add(new winston.transports.Console({
    format: winston.format.combine(
      winston.format.colorize(),
      winston.format.simple()
    )
  }));
}

module.exports = logger;
```

---

### éšæ®µäºŒï¼šæ€§èƒ½å„ªåŒ–ï¼ˆä¸­å„ªå…ˆç´šï¼‰

#### 5. æ•¸æ“šåº«æŸ¥è©¢å„ªåŒ– â­â­â­â­

**å„ªåŒ–é‡é»**:

**A. æ‰¹é‡æ“ä½œ**
```javascript
// âŒ å·®çš„åšæ³•ï¼šN æ¬¡æŸ¥è©¢
for (const playerId of playerIds) {
  const player = await db.collection('players').doc(playerId).get();
  // ...
}

// âœ… å¥½çš„åšæ³•ï¼š1 æ¬¡æŸ¥è©¢
const players = await db.collection('players')
  .where('id', 'in', playerIds)
  .get();
```

**B. ä½¿ç”¨ç´¢å¼•**
```javascript
// å‰µå»ºè¤‡åˆç´¢å¼•
// Firestore Console -> Indexes
// Collection: leaderboard
// Fields: score (Descending), created_at (Descending)
```

**C. åˆ†é å„ªåŒ–**
```javascript
// âŒ å·®çš„åšæ³•ï¼šæ¯æ¬¡å¾é ­æŸ¥
const startAt = (page - 1) * limit;
const players = await db.collection('leaderboard')
  .orderBy('score', 'desc')
  .limit(limit)
  .offset(startAt)
  .get();

// âœ… å¥½çš„åšæ³•ï¼šä½¿ç”¨ cursor
let query = db.collection('leaderboard')
  .orderBy('score', 'desc')
  .limit(limit);

if (lastDocumentSnapshot) {
  query = query.startAfter(lastDocumentSnapshot);
}

const snapshot = await query.get();
```

**D. ç·©å­˜ç­–ç•¥**
```javascript
// services/cache.service.js
class CacheService {
  constructor() {
    this.cache = new Map();
    this.ttl = 5 * 60 * 1000; // 5 åˆ†é˜
  }

  async getOrFetch(key, fetchFn) {
    const cached = this.cache.get(key);

    if (cached && Date.now() - cached.time < this.ttl) {
      return cached.data;
    }

    const data = await fetchFn();
    this.cache.set(key, { data, time: Date.now() });
    return data;
  }

  invalidate(key) {
    this.cache.delete(key);
  }
}
```

#### 6. éŸ¿æ‡‰å£“ç¸® â­â­â­

```javascript
// server.js
const compression = require('compression');

app.use(compression({
  filter: (req, res) => {
    if (req.headers['x-no-compression']) {
      return false;
    }
    return compression.filter(req, res);
  },
  level: 6 // å£“ç¸®ç´šåˆ¥ 0-9
}));
```

---

### éšæ®µä¸‰ï¼šé–‹ç™¼é«”é©—ï¼ˆä½å„ªå…ˆç´šï¼‰

#### 7. API æ–‡æª” (Swagger) â­â­â­

```javascript
// swagger.js
const swaggerJsdoc = require('swagger-jsdoc');
const swaggerUi = require('swagger-ui-express');

const options = {
  definition: {
    openapi: '3.0.0',
    info: {
      title: 'æ„›å¿ƒäº’å‹•éŠæˆ² API',
      version: '3.0.0',
      description: 'å®Œæ•´çš„ REST API æ–‡æª”'
    },
    servers: [
      { url: 'http://localhost:3000', description: 'é–‹ç™¼ç’°å¢ƒ' },
      { url: 'https://your-domain.com', description: 'ç”Ÿç”¢ç’°å¢ƒ' }
    ]
  },
  apis: ['./routes/*.js']
};

const specs = swaggerJsdoc(options);

module.exports = { specs, swaggerUi };
```

#### 8. å¥åº·æª¢æŸ¥å¢å¼· â­â­â­

```javascript
// routes/health.routes.js
router.get('/health', async (req, res) => {
  const health = {
    status: 'ok',
    timestamp: new Date().toISOString(),
    uptime: process.uptime(),
    checks: {
      database: await checkFirestore(),
      cache: await checkRedis(),
      memory: checkMemory()
    }
  };

  const isHealthy = Object.values(health.checks).every(c => c.status === 'ok');
  res.status(isHealthy ? 200 : 503).json(health);
});
```

---

## ğŸ”§ å¯¦æ–½å„ªå…ˆç´š

### ç¬¬ä¸€é€±ï¼šå®‰å…¨åŸºç¤ ğŸ”´

- [ ] Day 1-2: çµ±ä¸€éŒ¯èª¤è™•ç†ä¸­é–“ä»¶
- [ ] Day 3-4: è«‹æ±‚é©—è­‰å±¤ (Joi)
- [ ] Day 5-6: é€Ÿç‡é™åˆ¶
- [ ] Day 7: æ¸¬è©¦èˆ‡èª¿æ•´

### ç¬¬äºŒé€±ï¼šæ€§èƒ½å„ªåŒ– ğŸŸ¡

- [ ] Day 1-2: é€²éšæ—¥èªŒç³»çµ±
- [ ] Day 3-4: æ•¸æ“šåº«æŸ¥è©¢å„ªåŒ–
- [ ] Day 5: éŸ¿æ‡‰å£“ç¸®
- [ ] Day 6-7: æ€§èƒ½æ¸¬è©¦

### ç¬¬ä¸‰é€±ï¼šé–‹ç™¼é«”é©— ğŸŸ¢

- [ ] Day 1-3: Swagger API æ–‡æª”
- [ ] Day 4-5: å¥åº·æª¢æŸ¥å¢å¼·
- [ ] Day 6-7: æ•´åˆæ¸¬è©¦

---

## ğŸ“¦ éœ€è¦å®‰è£çš„å¥—ä»¶

```json
{
  "dependencies": {
    "joi": "^17.11.0",          // è«‹æ±‚é©—è­‰
    "express-rate-limit": "^7.1.5",  // é€Ÿç‡é™åˆ¶
    "winston": "^3.11.0",       // æ—¥èªŒç³»çµ±
    "winston-daily-rotate-file": "^4.7.1",  // æ—¥èªŒè¼ªè½‰
    "compression": "^1.7.4",    // éŸ¿æ‡‰å£“ç¸®
    "helmet": "^7.1.0",         // å®‰å…¨æ¨™é ­
    "swagger-jsdoc": "^6.2.8",  // API æ–‡æª”
    "swagger-ui-express": "^5.0.0"  // API æ–‡æª” UI
  }
}
```

å®‰è£å‘½ä»¤ï¼š
```bash
npm install joi express-rate-limit winston winston-daily-rotate-file compression helmet swagger-jsdoc swagger-ui-express
```

---

## ğŸ¯ é æœŸæ•ˆæœ

### æ€§èƒ½æå‡

| æŒ‡æ¨™ | å„ªåŒ–å‰ | å„ªåŒ–å¾Œ | æ”¹é€² |
|------|--------|--------|------|
| å¹³å‡éŸ¿æ‡‰æ™‚é–“ | 150ms | 50ms | â¬‡ï¸ 67% |
| æ•¸æ“šåº«æŸ¥è©¢ | N æ¬¡ | 1 æ¬¡ | â¬‡ï¸ 90% |
| éŸ¿æ‡‰å¤§å° | 100KB | 30KB | â¬‡ï¸ 70% |
| éŒ¯èª¤è¿½è¹¤æ™‚é–“ | 30min | 5min | â¬‡ï¸ 83% |

### å®‰å…¨æå‡

- âœ… é˜²æ­¢ SQL æ³¨å…¥ï¼ˆè«‹æ±‚é©—è­‰ï¼‰
- âœ… é˜²æ­¢ DDoSï¼ˆé€Ÿç‡é™åˆ¶ï¼‰
- âœ… é˜²æ­¢ XSSï¼ˆHelmet å®‰å…¨æ¨™é ­ï¼‰
- âœ… çµ±ä¸€éŒ¯èª¤è™•ç†ï¼ˆé¿å…ä¿¡æ¯æ´©æ¼ï¼‰

### é–‹ç™¼é«”é©—

- âœ… API æ–‡æª”è‡ªå‹•ç”Ÿæˆ
- âœ… è©³ç´°çš„æ—¥èªŒè¿½è¹¤
- âœ… æ›´å¥½çš„éŒ¯èª¤ä¿¡æ¯
- âœ… å®Œå–„çš„å¥åº·æª¢æŸ¥

---

## ğŸš€ ç«‹å³é–‹å§‹

### å¿«é€Ÿå„ªåŒ–ï¼ˆ1 å°æ™‚å…§ï¼‰

æœ€å°æ”¹å‹•ï¼Œæœ€å¤§æ•ˆæœï¼š

```bash
# 1. å®‰è£é—œéµå¥—ä»¶
npm install express-rate-limit helmet compression

# 2. åœ¨ server.js æ·»åŠ 
const rateLimit = require('express-rate-limit');
const helmet = require('helmet');
const compression = require('compression');

app.use(helmet());
app.use(compression());
app.use('/api', rateLimit({ windowMs: 60000, max: 60 }));
```

é€™ 3 è¡Œä»£ç¢¼å°±èƒ½ï¼š
- âœ… å¢åŠ å®‰å…¨é˜²è­·
- âœ… æ¸›å°‘ 70% éŸ¿æ‡‰å¤§å°
- âœ… é˜²æ­¢ API æ¿«ç”¨

---

## ğŸ“ ç¸½çµ

### ä½ çš„å¾Œç«¯ç¾ç‹€

âœ… **å„ªé»**:
- æ¶æ§‹æ¸…æ™°ï¼Œæ¨¡çµ„åŒ–è‰¯å¥½
- Firebase + Redis é›™å±¤å­˜å„²
- ç›£æ§ç³»çµ±å®Œå–„
- æ¸¬è©¦è…³æœ¬é½Šå…¨

âš ï¸ **å¯æ”¹é€²**:
- ç¼ºå°‘çµ±ä¸€éŒ¯èª¤è™•ç†
- ç¼ºå°‘è«‹æ±‚é©—è­‰
- ç¼ºå°‘é€Ÿç‡é™åˆ¶
- æ—¥èªŒç³»çµ±ç°¡å–®

### å»ºè­°è¡Œå‹•

1. **ç«‹å³åš**ï¼ˆ1 å°æ™‚ï¼‰ï¼š
   - æ·»åŠ  helmet + compression + rate-limit

2. **æœ¬é€±åš**ï¼ˆ1 å¤©ï¼‰ï¼š
   - çµ±ä¸€éŒ¯èª¤è™•ç†
   - è«‹æ±‚é©—è­‰å±¤

3. **ä¸‹é€±åš**ï¼ˆ2-3 å¤©ï¼‰ï¼š
   - æ—¥èªŒç³»çµ±
   - æŸ¥è©¢å„ªåŒ–

---

**ä½ è¦æˆ‘ç«‹å³å¹«ä½ å¯¦æ–½é€™äº›å„ªåŒ–å—ï¼Ÿ** ğŸš€

æˆ‘å¯ä»¥ï¼š
1. âœ… ç«‹å³æ·»åŠ  3 å€‹é—œéµä¸­é–“ä»¶ï¼ˆ5 åˆ†é˜ï¼‰
2. âœ… å‰µå»ºéŒ¯èª¤è™•ç†ç³»çµ±ï¼ˆ15 åˆ†é˜ï¼‰
3. âœ… æ·»åŠ è«‹æ±‚é©—è­‰ï¼ˆ30 åˆ†é˜ï¼‰
4. âœ… å¯¦æ–½é€Ÿç‡é™åˆ¶ï¼ˆ15 åˆ†é˜ï¼‰

**ç¸½æ™‚é–“ï¼šç´„ 1 å°æ™‚ï¼Œè®“ä½ çš„å¾Œç«¯æå‡åˆ°ä¼æ¥­ç´šï¼**
